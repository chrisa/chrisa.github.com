
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Chris's Blog</title>
  <meta name="author" content="Chris Andrews">

  
  <meta name="description" content="I&#8217;ve done some work with DTrace and Perl, using my
Devel::DTrace::Provider
and Andy Armstrong&#8217;s
Devel::DTrace, but
there&#8217;s never &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://chrisa.github.com/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Chris's Blog" type="application/atom+xml">
  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26543505-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Chris's Blog</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:chrisa.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul role=main-navigation>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/26/a-perl-ustack-helper/">A Perl <tt>ustack</tt> Helper?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-26T00:00:00+00:00" pubdate data-updated="true">Jan 26<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve done some work with DTrace and Perl, using my
<a href="https://metacpan.org/module/Devel::DTrace::Provider">Devel::DTrace::Provider</a>
and Andy Armstrong&#8217;s
<a href="https://metacpan.org/module/Devel::DTrace">Devel::DTrace</a>, but
there&#8217;s never been a ustack helper: because of the structure of the
Perl interpreter, it&#8217;s
<a href="https://blogs.oracle.com/levon/entry/python_and_dtrace_in_build#comment-1180088715000">impossible</a>
to write one &#8211; at least, in the intended manner&#8230;</p>

<h2>Perl and ustack helpers - the big problem</h2>

<p>The primary problem with a Perl ustack helper is the lack of
correspondence between the C stack and the Perl stack: unlike Python,
V8 Javascript etc, Perl&#8217;s stack is handled entirely separately, and
this is why the &#8220;standard&#8221; ustack helper will never be possible: there
just aren&#8217;t the C stack frames there to annotate.</p>

<p>What we can try though, is to annotate a single C frame with as much
of the Perl stack as we can find by chasing pointers from that frame.</p>

<p>This post explains my experiments with that idea. To give the game
away early, it doesn&#8217;t entirely work, but there are some techniques
here that might be useful elsewhere.</p>

<p>A lot of what I&#8217;ve done here is based directly on the existing ustack
helpers for other languages, specifically V8 and Python.</p>

<h2>Dynamically loading the ustack helper</h2>

<p>If at all possible, I want the helper to work on an unmodified Perl
binary - if the thing works at all, I want to be able to use it like a
CPAN-style module rather than having to patch Perl. The first problem
is to get the the helper loaded.</p>

<p>Given the way <a href="https://github.com/chrisa/libusdt">libusdt</a> works, it
seems likely we can load a helper just like a provider, by
<code>ioctl()</code>ing the DOF down to the kernel from a Perl XS
extension. Of course, that&#8217;s all DTrace&#8217;s DOF-loading <code>_init</code>
routine does anyway, just we&#8217;ll be doing it slightly later on in the
process&#8217;s life.</p>

<p>Unfortunately this facility <a href="https://github.com/chrisa/libusdt/issues/6">isn&#8217;t part of libusdt&#8217;s public API yet</a>, but it&#8217;s really not
that much code, especially if we&#8217;re only supporting Illumos-based
systems.</p>

<p>Actually building the helper DOF is trivial: compile the script with
<code>dtrace_program_fcompile()</code>, and wrap it in DOF with
<code>dtrace_dof_create()</code>.</p>

<p>Loading the DOF containing the helper program works, and means we can
initialise the helper from an extension module, rather needing to
patch it into Perl&#8217;s build process.</p>

<h2>Finding - or rather creating - a frame to annotate</h2>

<p>Ideally we need a stack frame which is always found in the
interpreter&#8217;s C stack, for which we can easily find the address of the
function, and where the stack is passed as one of the
arguments. There&#8217;s no such frame in the standard Perl interpreter, but
we can manufacture one. Perl lets us replace the &#8220;runops loop&#8221; with
one of our own, and we can use this to meet all of our requirements.</p>

<p>The runops loop function is the core of the interpreter, responsible
for invoking the current &#8220;op&#8221;, which returns the new current op.</p>

<p>The usual, non-debug, runops loop looks like this (in Perl 5.16.2):</p>

<figure class='code'><figcaption><span>Standard Perl runops loop (run.c) </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">Perl_runops_standard</span><span class="p">(</span><span class="n">pTHX</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">dVAR</span><span class="p">;</span>
</span><span class='line'>    <span class="k">register</span> <span class="n">OP</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">PL_op</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">((</span><span class="n">PL_op</span> <span class="o">=</span> <span class="n">op</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">op_ppaddr</span><span class="p">(</span><span class="n">aTHX</span><span class="p">)))</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">TAINT_NOT</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The top-level loop is always visible during execution, and we can
replace the usual function with one of our own, fulfilling our first
two requirements.</p>

<p>If we make this loop execute ops through another function, and pass
that function a pointer to the Perl stack, we fulfill the final
requirement. These functions are dtrace_runops and dtrace_call_op:</p>

<figure class='code'><figcaption><span>Modified runops loop (Helper.c) </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">STATIC</span> <span class="n">OP</span> <span class="o">*</span>
</span><span class='line'><span class="nf">dtrace_call_op</span><span class="p">(</span><span class="n">pTHX_</span> <span class="n">PERL_CONTEXT</span> <span class="o">*</span><span class="n">stack</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">CALL_FPTR</span><span class="p">(</span><span class="n">PL_op</span><span class="o">-&gt;</span><span class="n">op_ppaddr</span><span class="p">)(</span><span class="n">aTHX</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">STATIC</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">dtrace_runops</span><span class="p">(</span><span class="n">pTHX</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span> <span class="n">PL_op</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span> <span class="n">PL_op</span> <span class="o">=</span> <span class="n">dtrace_call_op</span><span class="p">(</span><span class="n">aTHX_</span> <span class="n">cxstack</span><span class="p">),</span> <span class="n">PL_op</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">PERL_ASYNC_CHECK</span><span class="p">(</span>  <span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">TAINT_NOT</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&#8217;ll target the annotation at dtrace_call_op(), and attempt to walk
the stack starting from the PERL_CONTEXT pointer we&#8217;re given.</p>

<p>Actually installing the alternative runops loop is a standard Perl
extension technique, and we just need to make sure it happens early
enough that the top-level loop is ours rather than the standard one.</p>

<h2>Frame annotations</h2>

<p>The primary purpose of the ustack helper is to provide a descriptive
string for a frame where there&#8217;s no corresponding C symbol - for
JITted code, say. If there is such a symbol, the ustack helper&#8217;s
string will be ignored - and in this case, there is,
<code>dtrace_call_op</code>.</p>

<p>Fortunately there&#8217;s a mechanism for adding annotations to these
frames, and that&#8217;s what we&#8217;ll use here: a string beginning with an
<code>@</code> will be used as an annotation. In the <a href="https://blogs.oracle.com/levon/entry/python_and_dtrace_in_build">Python
helper</a>,
it looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>libpython2.4.so.1.0`PyEval_EvalFrame+0xbdf
</span><span class='line'>           [ build/proto/lib/python/mercurial/localrepo.py:1849 (addchangegroup) ]</span></code></pre></td></tr></table></div></figure>


<h2>Targetting a specific frame</h2>

<p>In a helper action, <code>arg0</code> is the program counter in that stack
frame. If we make the address of our inserted <code>dtrace_call_op</code>
function available to the helper, and of the preceding function, we
can compare the pc to these two addresses to determine when we&#8217;re
annotating that function.</p>

<p>Here, <code>this-&gt;start</code> and <code>this-&gt;end</code> have been initialised to the
addresses of <code>dtrace_call_op</code> and the preceding function:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dtrace:helper:ustack:
</span><span class='line'>/this->pc >= this->start/
</span><span class='line'>{
</span><span class='line'>        this->go++;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>dtrace:helper:ustack:
</span><span class='line'>/this->pc &lt; this->end/
</span><span class='line'>{
</span><span class='line'>        this->go++;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>For a reason I&#8217;m not entirely sure of, combining these predicates into
one doesn&#8217;t work.</p>

<h2>Passing values into the helper</h2>

<p>With the extra control over the helper initialisation we get from
loading it &#8220;by hand&#8221;, it turns out that macros work fine! We can use
this to pass values into the helper: symbol addresses and structure
member offsets.</p>

<p>It doesn&#8217;t seem to be possible to simply <code>#include &lt;perl.h&gt;</code> - the D
compiler barfs badly on Perl&#8217;s headers, which are
.. involved. Fortunately we can do the necessary sizeof and offsetof
work in C and pass the results into D with macros. This should buy at
least some ability to cope with changes to Perl&#8217;s data structures,
though more sweeping changes will still break things entirely.</p>

<p>Macros are strings, so all the values passed need to be formatted with
<code>sprintf</code>; at least this is just setup code.</p>

<h2>Copying a C string</h2>

<p>Unless I&#8217;ve missed something, this is awkward. Our final stacktrace
string that the helper will return as the frame&#8217;s annotation is
allocated out of D scratch space, so we need to copy C strings from
userspace into it. If we have the string&#8217;s length available this is
easily done with <code>copyinto()</code>, but if we&#8217;ve just got a <code>char *</code>,
it&#8217;s not.</p>

<p>Ideally we could take the string&#8217;s length with <code>strlen()</code> and do a
copy &#8211; but <code>strlen</code> <a href="http://src.illumos.org/source/xref/illumos-gate/usr/src/uts/common/dtrace/dtrace.c#8595">isn&#8217;t available to helpers</a>.
It doesn&#8217;t seem to be possible to use <code>strchr()</code> either, since it
returns <code>string</code> and not <code>char *</code>, so we can&#8217;t find the length
that way.</p>

<p>I&#8217;m not sure if the lack of <code>strlen</code> is an oversight, or if there&#8217;s
some reason that it&#8217;s unsafe in arbitrary context: it seems that if
something like <code>strchr</code> is safe, <code>strlen</code> also ought to be.</p>

<p>We can&#8217;t just copy a fixed length of data, so a character-by-character
&#8220;strncpy&#8221; is needed:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/* Copy a string into this->buf, at the location indicated by this->off */
</span><span class='line'>
</span><span class='line'>#define APPEND_CHR_IF(offset, str) \
</span><span class='line'>dtrace:helper:ustack:                                                      \
</span><span class='line'>/this->go == 2 && !this->strdone/                                          \
</span><span class='line'>{                                                                          \
</span><span class='line'>    copyinto((uintptr_t)((char *)str + offset), 1, this->buf + this->off); \
</span><span class='line'>    this->off++;                                                           \
</span><span class='line'>}                                                                          \
</span><span class='line'>dtrace:helper:ustack:                                                      \
</span><span class='line'>/this->go == 2 && !this->strdone && this->buf[this->off - 1] == '\0'/      \
</span><span class='line'>{                                                                          \
</span><span class='line'>    this->strdone = 1;                                                     \
</span><span class='line'>    this->off--;                                                           \
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>#define APPEND_CSTR(str) \
</span><span class='line'>dtrace:helper:ustack:    \
</span><span class='line'>/this->go == 2/          \
</span><span class='line'>{                        \
</span><span class='line'>    this->strdone = 0;   \
</span><span class='line'>}                        \
</span><span class='line'>APPEND_CHR_IF(0, str) \
</span><span class='line'>APPEND_CHR_IF(1, str) \
</span><span class='line'>APPEND_CHR_IF(2, str) \
</span><span class='line'>...
</span><span class='line'>[ up to the length of string required]</span></code></pre></td></tr></table></div></figure>


<h2>Walking the stack</h2>

<p>After all that, actually walking the stack from the pointer we&#8217;ve been
passed is relatively simple. Using the information in <a href="http://cpansearch.perl.org/src/RURBAN/illguts-0.42/index-14.html">Perlguts Illustrated</a>,
we walk the context stack, appending frame annotations to our string buffer.</p>

<p>Obviously it&#8217;s only possible to walk a limited number of frames, and
with the default size limit on helper size and the ops required for
string copies, quite a limited number of frames.</p>

<h2>The output!</h2>

<p>Here&#8217;s an incredibly simple example of the output:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0     20                      write:entry 
</span><span class='line'>              libc.so.1`__write+0x15
</span><span class='line'>              libperl.so`PerlIOUnix_write+0x46
</span><span class='line'>              libperl.so`Perl_PerlIO_write+0x47
</span><span class='line'>              libperl.so`PerlIOBuf_flush+0x50
</span><span class='line'>              libperl.so`Perl_PerlIO_flush+0x45
</span><span class='line'>              libperl.so`PerlIOBuf_write+0x11d
</span><span class='line'>              libperl.so`Perl_PerlIO_write+0x47
</span><span class='line'>              libperl.so`Perl_do_print+0xa7
</span><span class='line'>              libperl.so`Perl_pp_print+0x195
</span><span class='line'>              Helper.so`dtrace_call_op+0x3f
</span><span class='line'>                [ 
</span><span class='line'>                  t/helper/01-helper.t:
</span><span class='line'>                  t/helper/01-helper.t:24
</span><span class='line'>                  t/helper/01-helper.t:25
</span><span class='line'>                  t/helper/01-helper.t:21
</span><span class='line'>                  t/helper/01-helper.t:17
</span><span class='line'>                  t/helper/01-helper.t:13
</span><span class='line'>                ]
</span><span class='line'>              Helper.so`dtrace_runops+0x56
</span><span class='line'>              libperl.so`perl_run+0x380
</span><span class='line'>              perl`main+0x15b
</span><span class='line'>              perl`_start+0x83</span></code></pre></td></tr></table></div></figure>


<p>This shows file:lineno pairs for each stack frame representing a
subroutine call that was found walking the context stack.</p>

<p>Here&#8217;s a (slightly) less trivial example, taken during a run of the
CPAN shell program:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0     20                      write:entry 
</span><span class='line'>              libc.so.1`__write+0x15
</span><span class='line'>              libperl.so`PerlIOUnix_write+0x46
</span><span class='line'>              libperl.so`Perl_PerlIO_write+0x47
</span><span class='line'>              libperl.so`PerlIOBuf_flush+0x50
</span><span class='line'>              libperl.so`Perl_PerlIO_flush+0x45
</span><span class='line'>              libperl.so`PerlIOBuf_write+0x11d
</span><span class='line'>              libperl.so`Perl_PerlIO_write+0x47
</span><span class='line'>              libperl.so`Perl_do_print+0xa7
</span><span class='line'>              libperl.so`Perl_pp_print+0x195
</span><span class='line'>              Helper.so`dtrace_call_op+0x3f
</span><span class='line'>                [ 
</span><span class='line'>                  -e:
</span><span class='line'>                  -e:1
</span><span class='line'>                  /opt/local/lib/perl5/5.14.0/CPAN.pm:325
</span><span class='line'>                  /opt/local/lib/perl5/5.14.0/CPAN.pm:325
</span><span class='line'>                  /opt/local/lib/perl5/5.14.0/CPAN.pm:345
</span><span class='line'>                  /opt/local/lib/perl5/5.14.0/CPAN.pm:421
</span><span class='line'>                  /opt/local/lib/perl5/5.14.0/CPAN/Shell.pm:1494
</span><span class='line'>                  /opt/local/lib/perl5/5.14.0/CPAN/Shell.pm:1461
</span><span class='line'>                ]
</span><span class='line'>              Helper.so`dtrace_runops+0x56
</span><span class='line'>              libperl.so`perl_run+0x246
</span><span class='line'>              perl`main+0x15b
</span><span class='line'>              perl`_start+0x83</span></code></pre></td></tr></table></div></figure>


<h2>The code, and its limitations</h2>

<p>The code is <a href="https://github.com/chrisa/perl-Devel-DTrace-Helper">available on Github</a>.
I don&#8217;t plan to release this module to CPAN any time soon!</p>

<p>For anything but the most trivial examples this code probably won&#8217;t
provide useful Perl stacktraces, and it&#8217;s only been tried on Perl
5.14.2 built with threads, on an Illumos-derived system.</p>

<p>It certainly won&#8217;t work on the Mac, since <a href="http://mail.opensolaris.org/pipermail/dtrace-discuss/2011-March/009088.html">ustack helpers are disabled
there</a>,
and won&#8217;t work without threads enabled in Perl because of an
implementation detail of Perl OPs we&#8217;re exploiting that&#8217;s different
without threads.</p>

<p>Hopefully though, this post sheds a bit of light on ustack helpers,
and maybe there are some interesting techniques here for other
situations.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/22/deploying-a-pki-with-chef/">Deploying a PKI With Chef</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-22T00:00:00+01:00" pubdate data-updated="true">Jul 22<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Traditionally, rolling out an X.509-style PKI has been a lot of
work. You&#8217;ve got to create the CA, generate all the necessary private
keys and distribute them securely, create signed certificates and
distribute those, and then do it all again when renewal time comes
around. Often this is enough work that a simpler security model is
used instead, like a shared secret.</p>

<p>With a modern configuration management system we ought to be able to
do better than this. Our CM system can know what certificates are
required where, and which CA should issue them. We&#8217;ve got an
authenticated transport, and the ability for an operator to control
the certificate issuing process from a central location.</p>

<p>This is the solution the <code>ssl</code> cookbook tries to provide for
Chef-managed infrastructures: it allows recipes to specify the
certificates required alongside the services which will use them,
generates private keys right on the host, and manages the certificate
issuing process via the Chef server and a separate command-line tool.</p>

<h2>Using the ssl_certificate resource</h2>

<p>To use the <code>ssl</code> cookbook, you&#8217;ll start by declaring as resources the
certificates your infrastructure needs. Probably the most common will
be a certificate for an https server - the standard &#8220;SSL certificate&#8221;
that gives the resource its name:</p>

<figure class='code'><figcaption><span>A typical ssl_certificate resource (ssl_certificate1.rb) </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="n">ssl_certificate</span> <span class="s2">&quot;www.example.com&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">ca</span> <span class="s2">&quot;MyCA&quot;</span>
</span><span class='line'>  <span class="n">key</span> <span class="s2">&quot;/etc/ssl/www.example.com.key&quot;</span>
</span><span class='line'>  <span class="n">certificate</span> <span class="s2">&quot;/etc/ssl/www.example.com.cert&quot;</span>
</span><span class='line'>  <span class="n">type</span> <span class="s2">&quot;server&quot;</span>
</span><span class='line'>  <span class="n">bits</span> <span class="mi">1024</span>
</span><span class='line'>  <span class="n">days</span> <span class="mi">365</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, we&#8217;re specifying a certificate whose Common Name is
&#8220;www.example.com&#8221;. The other parts of the certificate&#8217;s Distinguished
Name are set as node attributes, and needn&#8217;t be specified here.</p>

<p>The CA whose signature is requested here is <code>MyCA</code>. This is a string
which identifies your CA. It might identify an internal CA, or it
might be an abbreviation which indicates an external CA you might use,
but you need to choose an appropriate &#8220;short name&#8221; for your CA to use
here. Later, we&#8217;ll use this identifier to find the CSR to sign.</p>

<p>The key and certificate locations are given here, which you&#8217;d need to
also specify in your webserver configuration. The key is given
restrictive <code>0600</code> permissions, and ownership defaults to
<code>root:root</code>. The key itself is declared to be of type <code>server</code>, and of
length 1024 bits.</p>

<p>A validity period of 365 days is requested for the certificate. This
is a request, and need not be honoured when the CSR is signed, but it
will be respected if the automatic signing tool is used.</p>

<p>The first time this resource is converged, the key will be generated
and installed, and a temporary certificate signed by a temporary CA is
also installed &#8211; this allows a webserver configured to use the key
and certificate to start up successfully. Browsers connecting to the
server will see a warning, indicating the correct certificate is not
yet in place.</p>

<p>The Chef run also generates a CSR and PGP-encrypts the private key,
then saves them both into node attributes, in the &#8220;CSR Outbox&#8221;. This
contains the CSR, and the requested CA and validity period ready for
the signing tool.</p>

<h2>Signing certificates</h2>

<p>The <code>chef-ssl</code> tool is provided as a Ruby gem, called
<code>chef-ssl-client</code>, and is maintained in the cookbook&#8217;s git
repository. This is a standalone command line tool, which handles the
certificate issuing parts of the process, but which also provides for
the creation of new CAs and the issuing of ad hoc certificates.</p>

<p>Often you&#8217;ll be signing certificates with your own CA for internal
services, then deploying that CA to your clients. <code>chef-ssl</code> makes it
easy to sign CSRs for these internal CAs:</p>

<pre><code>$ chef-ssl autosign --ca-name MyCA --ca-path ./MyCA
</code></pre>

<p>You&#8217;ll be prompted for the CA key&#8217;s passphrase, and then a Chef search
will be performed, looking for data in individual nodes&#8217; outboxes. The
search is constrained by the CA identifier you specified.</p>

<p>Each matching CSR is then presented in turn, and if you&#8217;re happy to
issue the signed certificate, answering &#8220;yes&#8221; will do a number of
things:</p>

<ul>
<li>Create a certificate for the CSR</li>
<li>Sign the certificate with your CA</li>
<li>Upload the certificate as a Chef data bag item</li>
</ul>


<p>The data bag item is named for the Common Name of the certificate, and
contains all the information relating to the individual key and
certificate. The PGP-encrypted key is stored for archive purposes,
along with the CSR, and the certificate itself, the date and the
signing CA&#8217;s certificate. The data bag item may be archived for backup
of both the key and certificate.</p>

<h2>Installing Certificates</h2>

<p>On the next run after the certificate is issued and uploaded, Chef
notes the existence of the relevant data bag item, downloads it and
installs the certificate and the signing CA&#8217;s certificate.</p>

<p>Having installed the real certificate, Chef then removes the CSR from
the outbox &#8211; it&#8217;s important here that only the Chef node ever updates
the outbox, and only the <code>chef-ssl</code> script ever updates data bags. In
this way, clobbering of data is avoided, and it&#8217;s clear which part of
the system is responsible for each piece of data.</p>

<p>Notifications are sent when the new certificate is installed, which
allows (for example) the relevant web server to be restarted and begin
using the certificate.</p>

<h2>Summary</h2>

<p>This cookbook should allow you to concentrate on choosing the right
security architecture for your systems, rather than avoiding a genuine
PKI where it&#8217;s the right solution only because of the work involved.</p>

<p>The cookbook is available here:</p>

<pre><code>https://github.com/VendaTech/chef-cookbook-ssl
</code></pre>

<p>where further documentation and examples are available. GitHub issues
and pull requests are most welcome.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/05/custom-chef-gem-resources/">Custom <tt>chef_gem</tt> Resources</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-05T00:00:00+01:00" pubdate data-updated="true">Jul 5<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Since Chef 0.10.10, there&#8217;s been a new core resource for installing
Ruby gems to support Chef cookbooks: <tt>chef_gem</tt>. This installs
gems into the current Ruby at compile time, and handles making the
newly-installed gems available to the running Chef client &#8211; wrapping
up an ugly piece of code found in many cookbooks:</p>

<figure class='code'><figcaption><span>Before chef_gem (before.rb) </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="n">gem_package</span> <span class="s2">&quot;ruby-shadow&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">action</span> <span class="ss">:nothing</span>
</span><span class='line'><span class="k">end</span><span class="o">.</span><span class="n">run_action</span> <span class="ss">:install</span>
</span><span class='line'>
</span><span class='line'><span class="no">Gem</span><span class="o">.</span><span class="n">clear_paths</span>
</span></code></pre></td></tr></table></div></figure>


<p>into a single resource declaration:</p>

<figure class='code'><figcaption><span>With chef_gem (after.rb) </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="n">chef_gem</span> <span class="s2">&quot;ruby-shadow&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We hadn&#8217;t considered switching to this resource though, despite a
compatibility cookbook being <a
href="http://community.opscode.com/cookbooks/chef_gem">available</a>
for older Chef versions, because our local Ruby environment is based
on RPMs. We build a single Ruby RPM for all our management tools, with
individual gems also built into RPMs, so our gem dependency resources
specify <tt>yum_package</tt> rather than <tt>gem_package</tt>.</p>

<p>This hasn&#8217;t given us any problems beyond a need to patch cookbooks to
install our RPMs, but now we&#8217;re open sourcing some of our cookbooks,
it means that our dependencies are specific to our local environment.</p>

<p>Using <tt>chef_gem</tt> as an abstraction though, we can specify
dependencies in a way that&#8217;s appropriate for an open source cookbook
but have a local override which actually installs our RPMs. We also
avoid having to patch cookbooks just to make sure our RPMs are
installed for dependencies.</p>

<p>This is the resource definition, which is a shim between the
<tt>chef_gem</tt> resource and the <tt>yum_package</tt> provider,
adjusting the requested package name as we need for our RPMs.</p>

<figure class='code'><figcaption><span>Local chef_gem (libraries/chefgem.rb) </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">class</span> <span class="nc">Chef</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Resource</span>
</span><span class='line'>    <span class="k">begin</span>
</span><span class='line'>      <span class="nb">send</span><span class="p">(</span><span class="ss">:remove_const</span><span class="p">,</span> <span class="s1">&#39;ChefGem&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">rescue</span>
</span><span class='line'>      <span class="kp">nil</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">class</span> <span class="nc">ChefGem</span> <span class="o">&lt;</span> <span class="no">Chef</span><span class="o">::</span><span class="no">Resource</span><span class="o">::</span><span class="no">YumPackage</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">run_context</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>        <span class="c1"># our gem name -&gt; rpm name mapping</span>
</span><span class='line'>        <span class="nb">name</span> <span class="o">=</span> <span class="s2">&quot;rubygem19-</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="k">super</span>
</span><span class='line'>        <span class="vi">@resource_name</span> <span class="o">=</span> <span class="ss">:chef_gem</span>
</span><span class='line'>        <span class="vi">@provider</span> <span class="o">=</span> <span class="no">Chef</span><span class="o">::</span><span class="no">Provider</span><span class="o">::</span><span class="no">Package</span><span class="o">::</span><span class="no">Yum</span>
</span><span class='line'>        <span class="n">after_created</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">after_created</span>
</span><span class='line'>        <span class="nb">Array</span><span class="p">(</span><span class="vi">@action</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">action</span><span class="o">|</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">run_action</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="no">Gem</span><span class="o">.</span><span class="n">clear_paths</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code goes in a local-enviroment cookbook as a library. Once we
upgrade to Chef 0.10.10 or later, it will override the core
<tt>chef_gem</tt> resource, and continue to install our RPMs.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/12/04/libusdt-runtime-dtrace-providers/">Libusdt - Creating DTrace Providers at Runtime</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-04T00:00:00+00:00" pubdate data-updated="true">Dec 4<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>With this post I&#8217;d like to introduce <tt>libusdt</tt>, a library for
creating DTrace USDT providers at runtime, intended as the basis for
implementing custom DTrace providers in dynamic languages, but
applicable wherever the provider definition isn&#8217;t known at compile
time.</p>

<p>A bit of the history of this library: in 2007 I&#8217;d been tinkering with
a Ruby extension to allow access to libdtrace as a consumer of DTrace
data, with the hope that this might make it easier to write complex
analysis scripts - like <a href="https://github.com/chrisa/ruby-dtrace/blob/master/examples/scsi.rb">this port to ruby</a> of Chris Gerhard&#8217;s
<tt><a href="http://blogs.oracle.com/chrisg/entry/scsi_d_script">scsi.d</a></tt>
script.</p>

<p>At this point, the Ruby interpreter had been <a href="http://joyeur.com/2007/05/07/dtrace-for-ruby-is-available/">patched by Joyent</a>
to include its
own USDT provider, which was accessible using the consumer
library. What wasn&#8217;t possible though was to define providers in Ruby, to
create probes meaningful to the application rather than just to the
interpreter. My first attempt at this, autogenerating and building the
C source and D script required to specify a provider, was never going
to be anything other than an experiment.</p>

<p><a href="http://blogs.oracle.com/kamg/entry/adding_user_defined_dtrace_probes">This post</a>
by Keith McGuigan, though, showed that the JVM was capable of creating
providers at runtime without invoking the usual compile-time
machinery. It seemed that to do this using the existing USDT provider
in Solaris, it&#8217;d have to be doing a number of things:</p>

<ul>
<li>Dynamically creating tracepoints in the running process</li>
<li>Dynamically creating DOF to describe the provider to the kernel</li>
<li>Loading the DOF to enable the provider.</li>
</ul>


<p>Was the JVM doing all this? Keith&#8217;s blog post didn&#8217;t discuss the
low-level implementation, and there didn&#8217;t seem to be a way to do it
with libdtrace&#8230;</p>

<p>This was just before dtrace.conf(08). I was fortunate enough to attend
and was able to speak to Keith about the JVM implementation. It turns
out that this is pretty much how it works - the JVM with its
JIT-compiler already has the capability of creating new native code at
runtime, and creating the appropriate DOF document is simply a matter
of following the extensive documentation in <tt>&lt;sys/dtrace.h></tt>.</p>

<p>I got this working in Ruby, and so now
<a href="https://github.com/chrisa/ruby-dtrace/">ruby-dtrace</a> could both
produce and consume DTrace data, and eventually do it on all the
platforms supporting USDT providers - Solaris and Mac OS X, SPARC,
Intel and PowerPC, 32 and 64 bit (it&#8217;s entirely responsible for the
obsolete computers I still keep around&#8230;). This supported providers
like <a href="https://github.com/ecin/rack-probe">Rack::Probe</a>.</p>

<p><a href="https://github.com/chrisa/perl-dtrace/tree/master/Devel-DTrace-Provider">Devel::DTrace::Provider</a>
followed for Perl, like ruby-dtrace mostly in Perl - it was clear that
the core of these extensions needed to be a standalone library. One
more similar port,
<a href="https://github.com/chrisa/node-dtrace-provider">node-dtrace-provider</a>,
provoked a start on <tt>libusdt</tt>.</p>

<p>Incidentally the Perl port was written to add probes to my employer&#8217;s
large Perl web-app, for an evaluation on Solaris - we immediately
discovered unexpected behaviours, with the additional context provided
by the application&#8217;s probes going some way to making up for the lack
of a Perl stack helper.</p>

<p><tt><a href="https://github.com/chrisa/libusdt/">libusdt</a></tt> is currently
very limited - right now it only supports the Mac, and then only for
64 bit processes - but my plan is to bring over all the platform
support from ruby-dtrace and then to port all the language bindings
to use it as the core of their implementation.</p>

<p>Once that&#8217;s done, I&#8217;d like to find ways to reduce the disabled-probe
overhead - while is-enabled probes are supported and used to allow
costly argument-gathering work to be avoided where possible, the use
of generated stub functions means there&#8217;s still some overhead.</p>

<p>Some of this work will undoubtedly be language-specific, tying the
generated probes in more closely with the runtimes, but some may also
come from improvements in the library itself.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/12/03/ruby-1.9.2-and-yaml/">Ruby 1.9.2 and YAML</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-03T00:00:00+00:00" pubdate data-updated="true">Dec 3<span>rd</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I found another gotcha when embedding MCollective in a larger
application: Ruby&#8217;s YAML library situation. Historically Ruby has used
the Syck library, but since 1.9.2 libyaml is used if available,
through a set of bindings called Psych.</p>

<p>While Syck is still available and may be selected at runtime, the
default is chosen at compile time, based on the presence or not of
libyaml - if it&#8217;s there when you build Ruby, you&#8217;ll get Psych by
default.</p>

<p>To find out which binding your Ruby uses, inspect <tt>YAML::ENGINE.yamler</tt>:</p>

<figure class='code'><figcaption><span>Finding the current YAML library </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ruby-1.9.2-p290 :004 > YAML::ENGINE.yamler
</span><span class='line'> => "syck"</span></code></pre></td></tr></table></div></figure>


<p>This wouldn&#8217;t be a problem unless there were differences, and although
it&#8217;s fair to say that Psych is more compliant with the YAML spec, it&#8217;s
less tolerant of slight deviations - some of which Syck is guilty of.</p>

<p>Coming back to MCollective, this means that an MCollective running on
Ruby 1.9.2 with Psych won&#8217;t necessarily be able to communicate with
other MCollective installations running on Ruby 1.8 with Syck. Mostly
this seems to be down to handling of whitespace in multiline YAML
values, which MCollective makes heavy use of since it nests one YAML
document in another.</p>

<p>The initial fix in my environment was to rebuild Ruby 1.9.2 without
libyaml, so Syck is used everywhere. Beyond that, upgrading everything
to the same Ruby 1.9.2 build appears to be the best long term answer.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/10/25/embedding-mcollective/">Embedding MCollective</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-10-25T09:32:00+01:00" pubdate data-updated="true">Oct 25<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>MCollective is &#8220;a framework to build server orchestration or parallel
job execution systems&#8221;. It&#8217;s very easy to create and deploy agents to
your hosts, and then interrogate or instruct them with simple
command-line tools. For ad hoc tasks, this is ideal.</p>

<p>As part of our platform engineering work though, we&#8217;re integrating
MCollective with existing tools, and with our new orchestration
systems &#8211; using MCollective as the glue between a centralised
controller and its agents on individual hosts.</p>

<p>In this situation, our &#8220;client&#8221; isn&#8217;t a command-line tool but a larger
Rails application with a number of other dependencies. Bringing the
mcollective tools into this environment isn&#8217;t straightforward, since
a number of the default options need to be changed.</p>

<p>Here&#8217;s my first attempt to embed an MCollective client in my
application:</p>

<figure class='code'><figcaption><span>Embedding with default options (mco-embed.rb) </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="nb">require</span> <span class="s1">&#39;mcollective&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">EmbeddedClient</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">MCollective</span><span class="o">::</span><span class="no">RPC</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">client</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
</span><span class='line'>    <span class="n">client</span> <span class="o">=</span> <span class="n">rpcclient</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This has a number of problems.</p>

<p>I need to make the &#8220;mcollective&#8221; library code available. There&#8217;s
currently no gem available, so it&#8217;s not possible to just <tt>gem
&#8220;mcollective&#8221;, &#8220;1.2.0&#8221;</tt> in the Gemfile. There&#8217;s also the
MCollective plugins, which need to be in sync with the core library
version.</p>

<p>The configuration also needs to be available, and the default location
is /etc/mcollective/client.cfg - which is naturally outside of any
deployed application&#8217;s root, and so we&#8217;d need to deploy that
separately.</p>

<p>Having made the code available, the next problem to deal with is
command-line option parsing. By default, MCollective will parse and
validate the process&#8217;s ARGV, and raise an exception if it finds an
option it doesn&#8217;t recognise. This isn&#8217;t appropriate in an embedded
client, so we need to bypass option parsing.</p>

<p>Here&#8217;s how to create an embedded MCollective client, taking these
points into account:</p>

<figure class='code'><figcaption><span>Embedding, take 2 (mco-embed2.rb) </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="nb">require</span> <span class="s1">&#39;mcollective&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">EmbeddedClient</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">MCollective</span><span class="o">::</span><span class="no">RPC</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">client</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
</span><span class='line'>    <span class="n">options</span> <span class="o">=</span>  <span class="no">MCollective</span><span class="o">::</span><span class="no">Util</span><span class="o">.</span><span class="n">default_options</span>
</span><span class='line'>    <span class="n">options</span><span class="o">[</span><span class="ss">:config</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;config/mcollective.cfg&#39;</span>
</span><span class='line'>    <span class="n">client</span> <span class="o">=</span> <span class="n">rpcclient</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="p">{</span><span class="ss">:options</span> <span class="o">=&gt;</span> <span class="n">options</span><span class="p">})</span>
</span><span class='line'>    <span class="n">client</span><span class="o">.</span><span class="n">discovery_timeout</span> <span class="o">=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="n">client</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">120</span>
</span><span class='line'>    <span class="n">client</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>and here&#8217;s the configuration that points to:</p>

<figure class='code'><figcaption><span>Configuration (mcollective.cfg) </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='cfg'><span class='line'><span class="na">topicprefix</span> <span class="o">=</span> <span class="s">/topic/</span>
</span><span class='line'><span class="na">main_collective</span> <span class="o">=</span> <span class="s">mcollective</span>
</span><span class='line'><span class="na">collectives</span> <span class="o">=</span> <span class="s">mcollective</span>
</span><span class='line'><span class="na">libdir</span> <span class="o">=</span> <span class="s">vendor/mcollective/plugins</span>
</span><span class='line'><span class="na">logfile</span> <span class="o">=</span> <span class="s">stdout</span>
</span><span class='line'><span class="na">loglevel</span> <span class="o">=</span> <span class="s">debug</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Plugins</span>
</span><span class='line'><span class="na">securityprovider</span> <span class="o">=</span> <span class="s">psk</span>
</span><span class='line'><span class="na">plugin.psk</span> <span class="o">=</span> <span class="s">yeah</span>
</span><span class='line'>
</span><span class='line'><span class="na">connector</span> <span class="o">=</span> <span class="s">stomp</span>
</span><span class='line'><span class="na">plugin.stomp.host</span> <span class="o">=</span> <span class="s">10.101.1.16</span>
</span><span class='line'><span class="na">plugin.stomp.port</span> <span class="o">=</span> <span class="s">61613</span>
</span><span class='line'><span class="na">plugin.stomp.user</span> <span class="o">=</span> <span class="s">guest</span>
</span><span class='line'><span class="na">plugin.stomp.password</span> <span class="o">=</span> <span class="s">guest</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Facts</span>
</span><span class='line'><span class="na">factsource</span> <span class="o">=</span> <span class="s">yaml</span>
</span><span class='line'><span class="na">plugin.yaml</span> <span class="o">=</span> <span class="s">config/mcollective_facts.yaml</span>
</span></code></pre></td></tr></table></div></figure>


<p>This works, but there&#8217;s a problem - in rpcclient(), there&#8217;s a call to
<tt>exit!</tt> on any exception during the client setup process,
including exceptions thrown by the stomp library. We need to avoid
that and handle exceptions ourselves, so:</p>

<figure class='code'><figcaption><span>Embedding, take 3 (mco-embed3.rb) </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="nb">require</span> <span class="s1">&#39;mcollective&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">EmbeddedClient</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">MCollective</span><span class="o">::</span><span class="no">RPC</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">client</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
</span><span class='line'>    <span class="n">options</span> <span class="o">=</span>  <span class="no">MCollective</span><span class="o">::</span><span class="no">Util</span><span class="o">.</span><span class="n">default_options</span>
</span><span class='line'>    <span class="n">options</span><span class="o">[</span><span class="ss">:config</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;config/mcollective.cfg&#39;</span>
</span><span class='line'>    <span class="n">client</span> <span class="o">=</span> <span class="no">MCollective</span><span class="o">::</span><span class="no">RPC</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="ss">:options</span> <span class="o">=&gt;</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>    <span class="n">client</span><span class="o">.</span><span class="n">discovery_timeout</span> <span class="o">=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="n">client</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">120</span>
</span><span class='line'>    <span class="n">client</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can handle exceptions ourselves, but there&#8217;s still an issue -
the stomp library writes directly to $stderr and we should be
collecting that output and logging it in whatever way is appropriate
for the application:</p>

<figure class='code'><figcaption><span>Logging $stderr (mco-embed4.rb) </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">def</span> <span class="nf">log_stderr</span> <span class="o">&amp;</span><span class="n">block</span>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>    <span class="n">real_stderr</span><span class="p">,</span> <span class="vg">$stderr</span> <span class="o">=</span> <span class="vg">$stderr</span><span class="p">,</span> <span class="no">StringIO</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="k">yield</span>
</span><span class='line'>  <span class="k">ensure</span>
</span><span class='line'>    <span class="vg">$stderr</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">real_stderr</span><span class="p">,</span> <span class="vg">$stderr</span>
</span><span class='line'>    <span class="n">stderr</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">each_line</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
</span><span class='line'>      <span class="n">log</span><span class="p">(</span><span class="ss">:error</span><span class="p">,</span> <span class="s2">&quot;stderr: </span><span class="si">#{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># and then:</span>
</span><span class='line'><span class="n">log_stderr</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">run_mcollective_processes</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point, we&#8217;ve got the following problems solved:</p>

<ul>
<li>MCollective&#8217;s library code and plugins are within our application tree</li>
<li>The configuration file is also within the application</li>
<li>MCollective won&#8217;t try to reinterpret our application&#8217;s ARGV</li>
<li>We can handle client-setup exceptions ourselves</li>
<li>Stomp errors are logged, rather than being output to stderr.</li>
</ul>


<p>which should let the application interact with MCollective in a
reliable and maintainable way.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/01/26/a-perl-ustack-helper/">A Perl <tt>ustack</tt> helper?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/22/deploying-a-pki-with-chef/">Deploying a PKI with Chef</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/05/custom-chef-gem-resources/">Custom <tt>chef_gem</tt> resources</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/12/04/libusdt-runtime-dtrace-providers/">libusdt - creating DTrace providers at runtime</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/12/03/ruby-1.9.2-and-yaml/">Ruby 1.9.2 and YAML</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/chrisa">@chrisa</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'chrisa',
            count: 8,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("chrisandrews", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/chrisandrews" class="twitter-follow-button" data-show-count="false">Follow @chrisandrews</a>
  
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - <a href="mailto:chris@nodnol.org">Chris Andrews</a> -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
